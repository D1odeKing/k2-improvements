[gcode_macro RESONANCE_TORTURE]
description: Generate vibration patterns for quick resonance testing
gcode:
    {% set pattern = params.PATTERN|default("CORNER")|upper %}
    {% set moves = params.MOVES|default(50)|int %}
    {% set x_center = params.X|default(175)|float %}
    {% set y_center = params.Y|default(175)|float %}
    {% set amplitude = params.AMP|default(10)|float %}
    {% set speed_mms = params.SPEED|default(50)|float %}
    {% set speed_mmm = speed_mms * 60 %}
    
    # Save current position
    SAVE_GCODE_STATE NAME=RESONANCE_STATE
    
    # Absolute positioning
    G90
    
    # Move to starting position
    G1 X{x_center} Y{y_center} F{speed_mmm}
    
    {% if pattern == "CORNER" %}
        # Brutal corner infill simulation - diagonal oscillation
        {% for i in range(moves) %}
            {% if i % 2 == 0 %}
                G1 X{x_center + amplitude} Y{y_center + amplitude} F{speed_mmm}
            {% else %}
                G1 X{x_center - amplitude} Y{y_center - amplitude} F{speed_mmm}
            {% endif %}
        {% endfor %}
        
    {% elif pattern == "CROSS" %}
        # Cross pattern - alternating X/Y torture
        {% for i in range(moves) %}
            {% set phase = i % 4 %}
            {% if phase == 0 %}
                G1 X{x_center + amplitude} Y{y_center} F{speed_mmm}
            {% elif phase == 1 %}
                G1 X{x_center} Y{y_center + amplitude} F{speed_mmm}
            {% elif phase == 2 %}
                G1 X{x_center - amplitude} Y{y_center} F{speed_mmm}
            {% else %}
                G1 X{x_center} Y{y_center - amplitude} F{speed_mmm}
            {% endif %}
        {% endfor %}
        
    {% elif pattern == "SQUARE" %}
        # Rapid square corners - frame torture
        {% for i in range(moves // 4) %}
            G1 X{x_center + amplitude} Y{y_center + amplitude} F{speed_mmm}
            G1 X{x_center - amplitude} Y{y_center + amplitude} F{speed_mmm}
            G1 X{x_center - amplitude} Y{y_center - amplitude} F{speed_mmm}
            G1 X{x_center + amplitude} Y{y_center - amplitude} F{speed_mmm}
        {% endfor %}
        
    {% elif pattern == "ZIGZAG" %}
        # Aggressive zigzag - linear oscillation
        {% for i in range(moves) %}
            {% if i % 2 == 0 %}
                G1 X{x_center + amplitude} Y{y_center + ((i % 4 - 2) * amplitude / 2)} F{speed_mmm}
            {% else %}
                G1 X{x_center - amplitude} Y{y_center + ((i % 4 - 2) * amplitude / 2)} F{speed_mmm}
            {% endif %}
        {% endfor %}
        
    {% elif pattern == "CHAOS" %}
        # Chaotic pattern - pseudo-random brutal moves
        {% for i in range(moves) %}
            {% set x_mult = ((i * 7 + 3) % 13 - 6) / 6.0 %}
            {% set y_mult = ((i * 11 + 5) % 17 - 8) / 8.0 %}
            G1 X{x_center + amplitude * x_mult} Y{y_center + amplitude * y_mult} F{speed_mmm}
        {% endfor %}
        
    {% else %}
        {action_respond_info("Unknown pattern: %s" % pattern)}
        {action_respond_info("Available: CORNER, CROSS, SQUARE, ZIGZAG, CHAOS")}
    {% endif %}
    
    # Return to center
    G1 X{x_center} Y{y_center} F{speed_mmm}
    
    # Restore state
    RESTORE_GCODE_STATE NAME=RESONANCE_STATE
